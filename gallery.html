<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Gallery â€” Illustrations</title>
    <style>
        :root{--gap:12px;--bg:#0f0f10;--card:#111;--muted:#9aa0a6}
        html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,ui-sans-serif}
        .wrap{max-width:1300px;margin:28px auto;padding:0 18px}
        .masonry{column-width:300px;column-gap:var(--gap);}    @media (max-width:900px){.masonry{column-width:220px}}    @media (max-width:520px){.masonry{column-width:160px}}

        figure.item{display:inline-block;width:100%;margin:0 0 var(--gap);background:#111;border-radius:10px;overflow:hidden;box-shadow:0 6px 18px rgba(0,0,0,0.6);transform:translateY(20px);opacity:0;transition:opacity 2s ease, transform 1s ease;will-change:transform, opacity;break-inside:avoid;perspective:600px;cursor:pointer}
        figure.item.appear{opacity:1;transform:translateY(0)}
        figure.item img{display:block;width:100%;height:auto;vertical-align:middle;opacity:0;transition:opacity 2s ease}
        figure.item img.loaded{opacity:1}

        .thumb{position:relative}
        figure.item:hover{transform:translateY(-4px) rotateX(2deg) rotateY(-2deg);box-shadow:0 10px 24px rgba(0,0,0,0.7)}

        /* Modal Carousel */
        #modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:1000;opacity:0;transition:opacity 0.3s ease}
        #modal.show{display:flex;opacity:1}
        #carousel{position:relative;width:90vw;height:90vh;display:flex;align-items:center;justify-content:center}
        #carousel img{max-width:100%;max-height:80vh;border-radius:10px;box-shadow:0 0 20px rgba(255,255,255,0.1);object-fit:contain}
        .nav{position:fixed;top:50%;transform:translateY(-50%);width:60px;height:60px;border-radius:50%;border:none;background:rgba(255,255,255,0.2);color:#fff;font-size:24px;font-weight:bold;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:background 0.2s ease;z-index:1001}
        .nav:hover{background:rgba(255,255,255,0.4)}
        #prev{left:5%}
        #next{right:5%}
        #close{position:absolute;top:20px;right:20px;background:none;border:none;color:#fff;font-size:30px;cursor:pointer;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center}
        #close:hover{background:rgba(255,255,255,0.2)}
    </style>
</head>
<body>
<main class="wrap">
    <section id="gallery" class="masonry"></section>
</main>
<div id="modal">
    <div id="carousel">
        <button id="prev" class="nav">&lt;</button>
        <img id="carousel-img" src="" alt="Carousel Image">
        <button id="next" class="nav">&gt;</button>
    </div>
    <button id="close">&times;</button>
</div>

<script>
    const GALLERY_PATH = '/gallery/';
    const MANIFEST_URL = GALLERY_PATH + 'index.json';
    const FALLBACK_MANIFEST = ["REPLACE"];
    const BATCH_SIZE = 24;
    const galleryEl = document.getElementById('gallery');
    let manifest = [];
    let currentIndex = 0;

    const modal = document.getElementById('modal');
    const carouselImg = document.getElementById('carousel-img');
    const prevBtn = document.getElementById('prev');
    const nextBtn = document.getElementById('next');
    const closeBtn = document.getElementById('close');

    async function fetchManifest(){
      try{ const r = await fetch(MANIFEST_URL); if(!r.ok) throw 0; const j = await r.json(); return Array.isArray(j)? j: j.files;}catch(e){ return FALLBACK_MANIFEST.slice(); }
    }

    function createFigure(name, index){
      const fig = document.createElement('figure'); fig.className='item';
      const thumb = document.createElement('div'); thumb.className='thumb';

      const img = document.createElement('img'); img.setAttribute('data-src', GALLERY_PATH + name); img.loading='lazy'; thumb.appendChild(img);

      thumb.addEventListener('mousemove', e => {
        const r = thumb.getBoundingClientRect();
        const x = (e.clientX - r.left)/r.width - 0.5;
        const y = (e.clientY - r.top)/r.height - 0.5;
        fig.style.transform = `translateY(-4px) rotateX(${y*-8}deg) rotateY(${x*8}deg)`;
      });
      thumb.addEventListener('mouseleave', () => { fig.style.transform = ''});

      // Click to open carousel
      fig.addEventListener('click', () => {
        currentIndex = index;
        updateCarousel();
        modal.classList.add('show');
      });

      fig.appendChild(thumb);
      return fig;
    }

    function updateCarousel() {
      const name = manifest[currentIndex];
      carouselImg.src = GALLERY_PATH + name;
      prevBtn.style.display = currentIndex > 0 ? 'block' : 'none';
      nextBtn.style.display = currentIndex < manifest.length - 1 ? 'block' : 'none';
    }

    prevBtn.addEventListener('click', () => { if (currentIndex > 0) { currentIndex--; updateCarousel(); } });
    nextBtn.addEventListener('click', () => { if (currentIndex < manifest.length - 1) { currentIndex++; updateCarousel(); } });
    closeBtn.addEventListener('click', () => modal.classList.remove('show'));
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('show'); });

    const io = new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        const fig = entry.target;
        if (entry.isIntersecting) {
          const img = fig.querySelector('img');
          if (!img.src) {
            const src = img.getAttribute('data-src');
            img.src = src;
            img.onload=()=>{img.classList.add('loaded');};
          }
          fig.classList.add('appear');
        } else {
          fig.classList.remove('appear');
        }
      });
    },{rootMargin:'0px 0px 400px 0px', threshold: 0.1});

    function renderBatch(start){
      manifest.slice(start,start+BATCH_SIZE).forEach((name,i)=>{
        const fig=createFigure(name, start+i);
        galleryEl.appendChild(fig);
        io.observe(fig);
      });
    }

    (async()=>{
      manifest = await fetchManifest();
      manifest = manifest.map(s=>s.replace(/^\/+/,'').replace(/^gallery\//i,''));
      manifest.sort();
      renderBatch(0);
      let loaded=BATCH_SIZE;
      window.addEventListener('scroll',()=>{
        if(window.innerHeight+window.scrollY >= document.body.offsetHeight-800){
          if(loaded<manifest.length){ renderBatch(loaded); loaded+=BATCH_SIZE; }
        }
      });
    })();
</script>
</body>
</html>